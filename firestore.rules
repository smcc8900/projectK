rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getOrgId() {
      return request.auth.token.orgId;
    }
    
    function isAdmin() {
      return request.auth.token.role == 'admin';
    }
    
    function belongsToOrg(orgId) {
      return getOrgId() == orgId;
    }
    
    // Organizations
    match /organizations/{orgId} {
      // Allow public read for domain-based organization lookup (before login)
      // This is needed for the login page to detect which org the domain belongs to
      allow read: if true;
      // Only admins can write
      allow write: if isAdmin() && belongsToOrg(orgId);
    }
    
    // Users
    match /users/{userId} {
      // Allow reading individual user document if user belongs to same org
      allow read: if isAuthenticated() && 
                     belongsToOrg(resource.data.orgId);
      // Allow list queries (collection queries) for authenticated users
      // Firestore will validate each document matches the user's orgId
      allow list: if isAuthenticated();
      allow create: if isAdmin() && 
                       belongsToOrg(request.resource.data.orgId);
      // Allow users to update their own profile, or admins to update any user in their org
      allow update: if isAuthenticated() && 
                       (request.auth.uid == userId || 
                        (isAdmin() && belongsToOrg(resource.data.orgId)));
      allow delete: if isAdmin() && 
                       belongsToOrg(resource.data.orgId);
    }
    
    // Payslips
    match /payslips/{payslipId} {
      // Admin can read all in their org, employees can read their own
      allow read: if isAuthenticated() && 
                     belongsToOrg(resource.data.orgId) &&
                     (isAdmin() || request.auth.uid == resource.data.userId);
      allow create, update: if isAdmin() && 
                               belongsToOrg(request.resource.data.orgId);
      allow delete: if isAdmin() && 
                       belongsToOrg(resource.data.orgId);
    }
    
    // Upload History
    match /uploadHistory/{batchId} {
      allow read: if isAdmin() && belongsToOrg(resource.data.orgId);
      allow create: if isAdmin() && belongsToOrg(request.resource.data.orgId);
    }
    
    // Leave Requests
    match /leaveRequests/{requestId} {
      // Employees can create their own leave requests
      allow create: if isAuthenticated() && 
                       belongsToOrg(request.resource.data.organizationId) &&
                       request.auth.uid == request.resource.data.userId;
      // Employees can read their own requests, admins can read all in their org
      allow read: if isAuthenticated() && 
                     belongsToOrg(resource.data.organizationId) &&
                     (isAdmin() || request.auth.uid == resource.data.userId);
      // Only admins can update (approve/reject) leave requests
      allow update: if isAdmin() && belongsToOrg(resource.data.organizationId);
      // Only admins can delete leave requests
      allow delete: if isAdmin() && belongsToOrg(resource.data.organizationId);
    }
    
    // Leave Policies
    match /leavePolicies/{orgId} {
      // Anyone in the org can read the leave policy
      allow read: if isAuthenticated() && belongsToOrg(orgId);
      // Only admins can create/update leave policies
      allow write: if isAdmin() && belongsToOrg(orgId);
    }
    
    // Timetables
    match /timetables/{timetableId} {
      // Anyone in the org can read timetables
      allow read: if isAuthenticated() && 
                     belongsToOrg(resource.data.organizationId);
      // Only admins can create/update/delete timetables
      allow create: if isAdmin() && 
                       belongsToOrg(request.resource.data.organizationId);
      allow update: if isAdmin() && 
                       belongsToOrg(resource.data.organizationId);
      allow delete: if isAdmin() && 
                       belongsToOrg(resource.data.organizationId);
    }
  }
}

